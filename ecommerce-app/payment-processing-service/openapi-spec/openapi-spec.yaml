openapi: 3.0.3
info:
  title: Payment Processing Service API
  description: >
    Microservice responsible for handling payment intents, confirmations,
    refunds, and payment status for an e-commerce platform.
  version: 1.0.0
  contact:
    name: Payments Team
    email: payments@example.com

servers:
  - url: https://api.example.com/payments
    description: Production
  - url: https://sandbox.api.example.com/payments
    description: Sandbox

tags:
  - name: Payments
    description: Payment creation and confirmation
  - name: Refunds
    description: Refund management
  - name: Webhooks
    description: Payment provider callbacks
  - name: Health
    description: Service health checks

paths:
  /payments:
    post:
      tags: [Payments]
      summary: Create a payment intent
      description: Initializes a payment for an order.
      operationId: createPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      responses:
        '201':
          description: Payment intent created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payments/{paymentId}:
    get:
      tags: [Payments]
      summary: Get payment details
      operationId: getPayment
      parameters:
        - $ref: '#/components/parameters/PaymentId'
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '404':
          $ref: '#/components/responses/NotFound'

  /payments/{paymentId}/confirm:
    post:
      tags: [Payments]
      summary: Confirm a payment
      description: Confirms and processes the payment with the payment provider.
      operationId: confirmPayment
      parameters:
        - $ref: '#/components/parameters/PaymentId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmPaymentRequest'
      responses:
        '200':
          description: Payment confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '409':
          description: Invalid payment state

  /payments/{paymentId}/refunds:
    post:
      tags: [Refunds]
      summary: Create a refund
      operationId: createRefund
      parameters:
        - $ref: '#/components/parameters/PaymentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRefundRequest'
      responses:
        '201':
          description: Refund created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Refund'
        '400':
          $ref: '#/components/responses/BadRequest'

  /webhooks/payment-provider:
    post:
      tags: [Webhooks]
      summary: Payment provider webhook
      description: Receives asynchronous events from payment providers.
      operationId: handleWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
      responses:
        '200':
          description: Webhook processed

  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

components:
  parameters:
    PaymentId:
      name: paymentId
      in: path
      required: true
      schema:
        type: string
        format: uuid

  schemas:
    CreatePaymentRequest:
      type: object
      required: [orderId, amount, currency, method]
      properties:
        orderId:
          type: string
        amount:
          type: integer
          description: Amount in smallest currency unit (e.g. cents)
        currency:
          type: string
          example: USD
        method:
          type: string
          example: card
        customerId:
          type: string
        metadata:
          type: object
          additionalProperties: true

    ConfirmPaymentRequest:
      type: object
      properties:
        paymentMethodToken:
          type: string
          description: Token from payment provider

    Payment:
      type: object
      required: [id, orderId, amount, currency, status, createdAt]
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
        amount:
          type: integer
        currency:
          type: string
        status:
          type: string
          enum: [created, pending, succeeded, failed, refunded]
        provider:
          type: string
          example: stripe
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateRefundRequest:
      type: object
      required: [amount]
      properties:
        amount:
          type: integer
        reason:
          type: string

    Refund:
      type: object
      required: [id, paymentId, amount, status]
      properties:
        id:
          type: string
          format: uuid
        paymentId:
          type: string
          format: uuid
        amount:
          type: integer
        status:
          type: string
          enum: [pending, succeeded, failed]
        createdAt:
          type: string
          format: date-time

    WebhookEvent:
      type: object
      required: [type, data]
      properties:
        type:
          type: string
          example: payment.succeeded
        data:
          type: object
          additionalProperties: true

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          example: ok
        timestamp:
          type: string
          format: date-time

  responses:
    BadRequest:
      description: Invalid request
    Unauthorized:
      description: Authentication required
    NotFound:
      description: Resource not found

security:
  - BearerAuth: []

componentsSecuritySchemes:
  BearerAuth:
    type: http
    scheme: bearer
    bearerFormat: JWT
